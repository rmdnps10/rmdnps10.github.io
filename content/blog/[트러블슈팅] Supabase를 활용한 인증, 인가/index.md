---
title: "[íŠ¸ëŸ¬ë¸”ìŠˆíŒ…] Supabase Authë¥¼ í™œìš©í•œ ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œì˜ ì„¸ì…˜ ìœ ì§€"
slug: "troubleshooting-supabase-auth"
date: "2026-02-10"
description: "RLSë¥¼ ì¼œìë§ˆì permission denied, SSRì—ì„œ í† í° null, Extensionì—ì„œ 1ì‹œê°„ ë’¤ 401. Supabase Auth ê¸°ë°˜ ì¸ì¦ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ë©° ë§ˆì£¼í•œ ë¬¸ì œë“¤ê³¼ í•´ê²° ê³¼ì •ì„ ê¸°ë¡í•œë‹¤."
thumbnail: "./index.png"
pointColor: "#3ECF8D"
tags: ["Web", "íšŒê³ "]
---

> ìµœê·¼ì— ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ë¡œ **BOJ AI Helper**ë¼ëŠ” ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
>
> Nest.js ì„œë²„, Next.js SSR&CSR, Chrome Extension í™˜ê²½ì—ì„œ Supabase Authë¥¼ í†µí•©í•˜ë©° ëª‡ê°€ì§€ ì¸ì¦ ì—ëŸ¬ë“¤ì„ ë§Œë‚¬ê³ , ì´ëŸ¬í•œ ì—ëŸ¬ë¥¼ ë§ë‹¥ëœ¨ë¦¬ë©° ì¸ì¦/ì¸ê°€ ì•„í‚¤í…ì²˜ë¥¼ ì„¤ê³„í•œ ê³¼ì •ì„ ê¸°ë¡í•©ë‹ˆë‹¤.

![BOJ AI Helperë¥¼ ê°œë°œí•˜ë©° ë§ë‹¥ëœ¨ë¦° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…ì„ ê¸°ë¡í•©ë‹ˆë‹¤.](./home-ui.png)

## í”„ë¡œì íŠ¸(BOJ AI Helper) ë°°ê²½

### í•™ìŠµ ê³¼ì •ì˜ ëˆ„ë½ëœ ë¶€ë¶„

ë°±ì¤€ ì˜¨ë¼ì¸ ì €ì§€ëŠ” ë¬¸ì œë¥¼ í’€ê³  ì œì¶œí•˜ë©´ "ë§ì•˜ìŠµë‹ˆë‹¤" ë˜ëŠ” "í‹€ë ¸ìŠµë‹ˆë‹¤" ê²°ê³¼ë¥¼ ì œê³µí•œë‹¤. í•˜ì§€ë§Œ ì œì¶œ ì´í›„ì˜ í•™ìŠµ ê³¼ì •ì€ ì‚¬ìš©ìì—ê²Œ ì „ì ìœ¼ë¡œ ë§¡ê²¨ì ¸ ìˆë‹¤.

**ë°±ì¤€ í”Œë«í¼ì˜ í•œê³„**

- ì œì¶œ ë‚´ì—­ì€ ì±„ì  ê²°ê³¼ë§Œ í‘œì‹œ
- í’€ì´ ê³¼ì •ì´ë‚˜ ì‚¬ê³  ë°©ì‹ì€ ê¸°ë¡ë˜ì§€ ì•ŠìŒ
- ë³µìŠµ ì‹œì ì„ ì‚¬ìš©ìê°€ ì§ì ‘ ê´€ë¦¬í•´ì•¼ í•¨
- ë°˜ë³µë˜ëŠ” ì‹¤ìˆ˜ íŒ¨í„´ì„ íŒŒì•…í•˜ê¸° ì–´ë ¤ì›€

ì¼ì£¼ì¼ ì „ì— í’€ì—ˆë˜ ë¬¸ì œë¥¼ ë‹¤ì‹œ ë³´ë©´ ì–´ë–»ê²Œ í’€ì—ˆëŠ”ì§€ ê¸°ì–µë‚˜ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ë§ë‹¤.
ë‹¨ìˆœíˆ `solved.ac` í‹°ì–´ë¥¼ ë†’ì´ê¸° ìœ„í•´ì„œ, ë¬¸ì œë¥¼ ë§ì´ í‘¸ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ì‹¤ì§ˆì ì¸ ì½”ë”© í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ê¸° ìœ„í•œ ì‹¤ë ¥ì„ ìŒ“ê¸°ëŠ” ì–´ë µë‹¤.

### ì œì¶œì„ í•™ìŠµ ì´ë²¤íŠ¸ë¡œ

BOJ AI HelperëŠ” ë°±ì¤€ì˜ ì œì¶œì„ ë‹¨ìˆœí•œ ì±„ì  ìš”ì²­ì´ ì•„ë‹ˆë¼ `í•˜ë‚˜ì˜ í•™ìŠµ ì´ë²¤íŠ¸`ë¡œ ë°”ë¼ë³¸ë‹¤.

í•˜ë‚˜ì˜ ì½”ë“œ ì œì¶œì—ëŠ” ë§ì€ ì •ë³´ë“¤ì´ ë‹´ê²¨ ìˆë‹¤.

- **í‹€ë¦° ì œì¶œ**: ì–´ë–¤ ë¶€ë¶„ì„ ì˜¤í•´í–ˆëŠ”ì§€, ì–´ë–¤ ì—£ì§€ ì¼€ì´ìŠ¤ë¥¼ ë†“ì³¤ëŠ”ì§€..
- **ë§ì€ ì œì¶œ**: ê·¸ ì‹œì ì˜ ì‚¬ê³  ë°©ì‹, ì„ íƒí•œ ì•Œê³ ë¦¬ì¦˜ê³¼ ìë£Œêµ¬ì¡°ê°€ ì ì ˆí–ˆëŠ”ì§€..

ì‚¬ëŒë§ˆë‹¤ ì½”í…Œë¥¼ ì¤€ë¹„í•˜ê¸° ìœ„í•œ ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ ê³µí†µì ìœ¼ë¡œ ì‹¤ìˆ˜í•˜ëŠ” íŒ¨í„´ì´ë‚˜ ë³¸ì¸ì˜ ì·¨ì•½ì ì´ ì¡´ì¬í•œë‹¤.
ì´ëŸ¬í•œ ë°ì´í„°ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ìˆ˜ì§‘í•˜ê³  ë¶„ì„í•˜ë©´ ê°œì¸í™”ëœ í•™ìŠµ í”¼ë“œë°±ì„ ì œê³µí•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ, ê°œë°œì„ ì‹œì‘í•˜ê²Œ ëë‹¤.

![ì„œë¹„ìŠ¤ í™”ë©´ -ì œì¶œ ìƒì„¸ ì •ë³´](./detail-ui.png)

### ëª©í‘œ

`BOJ AI Helper`ëŠ” **"ë¬¸ì œ í’€ì´ â†’ AI í”¼ë“œë°± â†’ ë³µìŠµ"** ë£¨í”„ë¥¼ í†µí•´, ìœ ì €ê°€ ì½”ë“œ ì‘ì„±ì— ìˆì–´ì„œ ìì‹ ì˜ ì•½ì ì„ ë³´ì™„í•˜ê³  ì‹¤ë ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë„ë¡ ë•ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•œë‹¤.

í˜„ì¬ê¹Œì§€ êµ¬í˜„í•œ í•µì‹¬ ê¸°ëŠ¥ì€ ì´ë ‡ë‹¤.

- ì œì¶œ ìë™ ìˆ˜ì§‘: `Chrome Extension`ìœ¼ë¡œ ë°±ì¤€ ì œì¶œ ë‚´ì—­ í¬ë¡¤ë§
- ì œì¶œ ë°ì´í„° ì˜ì†í™”: ì†ŒìŠ¤ ì½”ë“œ, ê²°ê³¼, ë¬¸ì œ ì •ë³´ ì €ì¥
- í•™ìŠµ ë°ì´í„° ê´€ë¦¬: ë©”ëª¨ ì‘ì„±, ë³µìŠµ ì¼ì • ê´€ë¦¬

ê·¸ë¦¬ê³  í–¥í›„ì— ìº¡ìŠ¤í†¤ í”„ë¡œì íŠ¸ ì§€ì›ê¸ˆì„ í™œìš©í•´ ì´ ê¸°ëŠ¥ê¹Œì§€ ì¶”ê°€ë¥¼ í•˜ê³ , ëŸ°ì¹­ì„ í•´ë³¼ ì˜ˆì •ì´ë‹¤.

- AI ê¸°ë°˜ ë¶„ì„:ì œì¶œ ë‚´ì—­ ê¸°ë°˜ í”¼ë“œë°± ë° íŒ¨í„´ ë¶„ì„

## Supabase Authì˜ ë„ì…

ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œëŠ” `Supabase`ë¥¼ Auth Providerë¡œì„œ í™œìš©í•˜ë©°, ë°ì´í„° ì ‘ê·¼ì€ ìì²´ ë°±ì—”ë“œ ì„œë²„ë¥¼ í†µí•´ ìˆ˜í–‰í–ˆë‹¤.
ì¦‰, í† í° ê²€ì¦ê³¼ í† í° ë°œê¸‰ì˜ ì±…ì„ì„ ì„œë²„ë‹¨ì´ ì•„ë‹Œ `Supabase Auth`ê°€ ë‹´ë‹¹í•˜ë„ë¡ ì„¤ê³„í–ˆë‹¤.

### ë„ì… ë°°ê²½

ì˜ˆì „ì— ì°¸ì—¬í•œ AI í•´ì»¤í†¤ì—ì„œ `Next.js`ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ë‹¨ë§Œì„ êµ¬í˜„í•˜ë©° `Supabase`ë¥¼ ì‚¬ì‹¤ìƒì˜ ë°±ì—”ë“œë¡œì„œ í™œìš©í•œ ê²½í—˜ì´ ìˆì—ˆëŠ”ë°, ë‹¹ì‹œì— ì§ì ‘ ë°±ì—”ë“œë¥¼ êµ¬í˜„í•˜ì§€ ì•Šê³  êµ‰ì¥íˆ ìˆ˜ì›”í•˜ê²Œ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì—ˆë‹¤.

ê·¸ ë‹¹ì‹œì— ê²½í—˜ìœ¼ë¡œ ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œë„ `Supabase Auth`ë¥¼ ë„ì…í•˜ê²Œ ë˜ì—ˆë‹¤.

í•˜ì§€ë§Œ ì´ë²ˆ í”„ë¡œì íŠ¸ëŠ” ë‹¨ìˆœí•œ í”„ë¡ íŠ¸ì—”ë“œ ì•±ì´ ì•„ë‹ˆë¼, `Next.js` í’€ìŠ¤íƒ ì•±ê³¼ `NestJS` ë°±ì—”ë“œ ì„œë²„, ê·¸ë¦¬ê³  `Chrome Extension`ê¹Œì§€ ì•„ìš°ë¥´ëŠ” ë³µí•©ì ì¸ ì•„í‚¤í…ì²˜ì˜€ê¸°ì—, `Supabase Auth`ë¥¼ í†µí•©í•˜ëŠ” ê³¼ì •ì—ì„œ ì—¬ëŸ¬ ê°€ì§€ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ìƒí™©ì— ì§ë©´í•˜ê²Œ ë˜ì—ˆë‹¤.

> ##### ì´ ê¸€ì—ì„œëŠ” `Supabase Auth`ë¥¼ í™œìš©í•˜ì—¬ í’€ìŠ¤íƒ ì¸ì¦/ì¸ê°€ ì•„í‚¤í…ì²˜ë¥¼ ì„¤ê³„í•˜ê³ , RLS ì„¤ì •, í† í° ê´€ë¦¬, í™˜ê²½ë³„ ì¸ì¦ ì²˜ë¦¬ ë¬¸ì œë¥¼ í•´ê²°í•œ ê²½í—˜ì„ ê³µìœ í•˜ê³ ì í•œë‹¤.

### ì¸ì¦ ì•„í‚¤í…ì²˜ ì„¤ê³„

ë¨¼ì € ì¸ì¦ ì•„í‚¤í…ì²˜ëŠ” ì•„ë˜ì™€ ê°™ì€ ì‹œë‚˜ë¦¬ì˜¤ í•˜ì— ì„¤ê³„í–ˆë‹¤.

#### ì¸ì¦ í”Œë¡œìš°

1. ì‚¬ìš©ìê°€ Next.js ì•±ì—ì„œ Supabase Authë¡œ ë¡œê·¸ì¸
2. Supabaseê°€ JWTì™€ refresh token ë°œê¸‰
3. Chrome Extensionì€ auth-bridgeë¥¼ í†µí•´ í† í° ìˆ˜ì‹ 
4. ëª¨ë“  API ìš”ì²­ì— JWT í¬í•¨
5. ì„œë²„ê°€ Supabase Authë¥¼ í†µí•´ JWT ê²€ì¦ í›„ DB ì ‘ê·¼

![ì¸ì¦ í”Œë¡œìš°](./flow.png)

**Client (Next.js / Chrome Extension)**

- `anon_key` + Supabase Auth SDKë¡œ JWT ë°œê¸‰
- ëª¨ë“  API ìš”ì²­ì— JWT í¬í•¨

**Server (NestJS)**

- ëª¨ë“  ì¸ì¦ í•„ìš” APIì— SupabaseAuthGuard ì‚¬ìš©, Supabase Authë¡œ ì‚¬ìš©ì ì‹ë³„
- `service_role` keyë¡œ DB ì ‘ê·¼

**Supabase (PostgreSQL + RLS)**

- Supabase Authë§Œ í´ë¼ì´ì–¸íŠ¸/í™•ì¥ í”„ë¡œê·¸ë¨ í™˜ê²½ì—ì„œ ì§ì ‘ ì‚¬ìš©
- DBëŠ” Nest(Prisma)ë§Œ ì‚¬ìš©

#### ì™œ ì´ë ‡ê²Œ ì„¤ê³„í•´ì•¼ë§Œ í•˜ë‚˜?

ì´ í”„ë¡œì íŠ¸ëŠ” Next.js ê¸°ë°˜ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ Chrome Extensionì´ ë™ì‹œì— ë™ì‘í•˜ëŠ” êµ¬ì¡°ì´ë‹¤. ë‘ í´ë¼ì´ì–¸íŠ¸ê°€ í•˜ë‚˜ì˜ ì¸ì¦ ì²´ê³„ë¥¼ ê³µìœ í•´ì•¼ í•œë‹¤.

ë‚˜ëŠ” ì•„ë˜ì˜ ì›ì¹™ë“¤ì„ ê³ ìˆ˜í•˜ì—¬ ì•„í‚¤í…ì²˜ë¥¼ ì„¤ê³„í–ˆë‹¤.

1. ë¸Œë¼ìš°ì € í™˜ê²½ì— service_role keyê°€ ë…¸ì¶œë˜ë©´ ì•ˆ ëœë‹¤.
2. ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹¨ì¼ ì„œë²„ë¥¼ í†µí•´ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤.
3. ì›¹ ì•±ê³¼ í™•ì¥ í”„ë¡œê·¸ë¨ì´ ë™ì¼í•œ ì¸ì¦ ì²´ê³„ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ë‘ í™˜ê²½ì´ ì„œë¡œ ë‹¤ë¥¸ ì¸ì¦ íë¦„ì„ ê°€ì§€ë©´ í† í° ë™ê¸°í™”ì™€ ê¶Œí•œ ê´€ë¦¬ê°€ ë³µì¡í•´ì§„ë‹¤.

í´ë¼ì´ì–¸íŠ¸ëŠ” Supabase Authë¥¼ í†µí•´ JWTë§Œ ë°œê¸‰ë°›ëŠ”ë‹¤.
ëª¨ë“  API ìš”ì²­ì€ í•´ë‹¹ JWTë¥¼ í¬í•¨í•´ ì„œë²„ë¡œ ì „ë‹¬í•œë‹¤.
ì„œë²„ëŠ” Supabase Auth APIë¥¼ í†µí•´ JWTë¥¼ ê²€ì¦í•˜ê³  ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•œë‹¤.
ì‹¤ì œ DB ì ‘ê·¼ì€ NestJS ì„œë²„ì—ì„œë§Œ ìˆ˜í–‰í•œë‹¤. ì´ë•Œ service_role keyëŠ” ì„œë²„ì—ë§Œ ì¡´ì¬í•œë‹¤.

#### ì„œë¹„ìŠ¤ ì „ì²´ ì•„í‚¤í…ì²˜

![ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜](./architecture.png)

**í•µì‹¬ êµ¬ì„± ìš”ì†Œ**

| êµ¬ì„± ìš”ì†Œ           | ì—­í•                                                                                 |
| ------------------- | ----------------------------------------------------------------------------------- |
| `boj-chrome-plugin` | ë°±ì¤€ status í˜ì´ì§€ì—ì„œ ì œì¶œ ë°ì´í„° í¬ë¡¤ë§, ì„œë²„ë¡œ Submission ì „ì†¡, ì•±ê³¼ì˜ ì¸ì¦ ì—°ë™ |
| `boj-helper-server` | Submission CRUD, Supabase JWT ê²€ì¦, Prismaë¥¼ í†µí•œ DB ì˜ì†í™”                         |
| `boj-helper-app`    | Supabase Auth ê¸°ë°˜ ë¡œê·¸ì¸, ì œì¶œ ëª©ë¡/ìƒì„¸/ë©”ëª¨ ê´€ë¦¬ UI ì œê³µ                         |

## 1ï¸âƒ£ ë‚´ê°€ ë§ë‹¥ëœ¨ë¦° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

ë‚˜ëŠ” ì‹œê°„ìˆœìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë“¤ì„ ê²ªì—ˆë‹¤. ë¨¼ì €, ë‚´ê°€ ê²ªì€ ë¬¸ì œë¥¼ ì†Œê°œí•˜ê³  ê¸€ì˜ í›„ë°˜ë¶€ì—ì„œ ê·¼ë³¸ ì›ì¸ ë¶„ì„ê³¼ í•´ê²°ì±…ì„ ë‹¤ë£¨ê³ ì í•œë‹¤.

### ì²«ë²ˆì§¸, RLS ë³´ì•ˆì„ í‚¤ë‹ˆê¹Œ permission denied..?

ê°œë°œì„ í•˜ë‹¤ê°€ DBì— `RLS` ë³´ì•ˆì„ ì„¤ì •í•˜ì§€ ì•Šê³  ê°œë°œì„ í•˜ê³  ìˆë‹¤ëŠ” ê²ƒì„ ê¹¨ë‹¬ì•˜ë‹¤. ë¬¸ë“ â€œì´ê±° RLS ì•ˆ ì¼œê³  ê°œë°œí•˜ëŠ” ê±° ìœ„í—˜í•œë°?â€ë¼ëŠ” ìƒê°ì´ ë“¤ì–´ RLSë¥¼ í™œì„±í™”í–ˆë‹¤. ì¼œìë§ˆì ì•± ì „ì²´ì—ì„œ `permission denied` ì—ëŸ¬ê°€ ë°œìƒí–ˆëŠ”ë°..

> ğŸ’¡ **RLS(Row Level Security)ë€?**
>
> ë°ì´í„°ë² ì´ìŠ¤ì˜ ê° í–‰(row)ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ì‚¬ìš©ìë³„ë¡œ ì œì–´í•˜ëŠ” `PostgreSQL`ì˜ ë³´ì•ˆ ê¸°ëŠ¥ì´ë‹¤.

ë°ì´í„° ë³´ì•ˆì„ ê°•í™”í•˜ê¸° ìœ„í•´ Supabaseì˜ RLS(Row Level Security)ë¥¼ í™œì„±í™”í–ˆë‹¤.

RLS OFF ìƒíƒœì—ì„œëŠ” ëª¨ë“  ì¿¼ë¦¬ê°€ ì •ìƒ ë™ì‘í–ˆë‹¤. í•˜ì§€ë§Œ RLSë¥¼ ì¼œëŠ” ìˆœê°„, Next.js ì•± ì „ì²´ì—ì„œ `permission denied` ì—ëŸ¬ê°€ í„°ì¡Œë‹¤.

- ë¡œê·¸ì¸ì€ ë˜ì–´ ìˆì—ˆë‹¤.
- í† í°ë„ ìˆì—ˆë‹¤.
  ê·¸ëŸ°ë° ì™œ `permission denied`ê°€ ë°œìƒí•˜ëŠ” ê±¸ê¹Œ?

### ë‘ë²ˆì§¸, SSRì—ì„œ ì•¡ì„¸ìŠ¤ í† í°ì´ null

ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ `getAccessToken()`ì„ í˜¸ì¶œí•˜ë©´ ê°„í—ì ìœ¼ë¡œ `null`ì´ ë°˜í™˜ëë‹¤.

```javascript
export async function getAccessToken() {
  const supabase = createClient()
  const {
    data: { session },
  } = await supabase.auth.getSession()

  return session?.access_token ?? null // âŒ ê°€ë” null ë°˜í™˜
}
```

ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì •ìƒ ë™ì‘í•˜ëŠ”ë°, ì„œë²„ì—ì„œë§Œ ì„¸ì…˜ì„ ìƒì–´ë²„ë¦¬ëŠ” í˜„ìƒì´ì—ˆë‹¤. Next.js App Routerì˜ SSR í™˜ê²½ì—ì„œ Supabase clientê°€ ì œëŒ€ë¡œ ì„¸ì…˜ì„ ìœ ì§€í•˜ì§€ ëª»í•˜ê³  ìˆì—ˆë‹¤.

### ì„¸ë²ˆì§¸, ë°±ì¤€ ë¬¸ì œ ì œì¶œí™˜ê²½ì—ì„œ í† í° ìë™ ê°±ì‹ ì„ ì–´ë–»ê²Œ ?

Chrome Extensionì„ ì„¤ì¹˜í•˜ê³  ë°±ì¤€ ì œì¶œì„ ëª‡ ê°œ ì˜¬ë¦° ë’¤ 1ì‹œê°„ ì •ë„ê°€ ì§€ë‚˜ë©´, ì„œë²„ì—ì„œ `401 Unauthorized` ì—ëŸ¬ê°€ ë°œìƒí•˜ê³ , ì´í›„ì— ì œì¶œì„ í•´ë„ ì œì¶œì´ ìˆ˜ì§‘ë˜ì§€ ì•ŠëŠ”ë‹¤. ìœ ì €ê°€ í™•ì¥ í”„ë¡œê·¸ë¨ì—ì„œ ì§ì ‘ ë¡œê·¸ì¸ì„ í•˜ì—¬ í† í°ì„ ì „ë‹¬í•´ì•¼ í–ˆë‹¤.
Supabase access tokenì˜ ì£¼ê¸°ê°€ 1ì‹œê°„ì´ê¸°ì—, ìœ ì € ì…ì¥ì—ì„œ 1ì‹œê°„ë§ˆë‹¤ ì§ì ‘ ì´ í–‰ë™ì„ í•œë‹¤ëŠ” ê²ƒì€ ë§¤ìš° ë¶ˆí¸í•œ ê²½í—˜ì´ì—ˆë‹¤.

```javascript
// ğŸš¨ 1ì‹œê°„ í›„ ì—ëŸ¬
POST /api/submissions
Authorization: Bearer [ë§Œë£Œëœ í† í°]
â†’ 401 Unauthorized
```

ë‚˜ëŠ” Supabase access tokenì˜ ê¸°ë³¸ ë§Œë£Œ ì‹œê°„ì´ 1ì‹œê°„ì´ë¼ëŠ” ê±¸ ê°„ê³¼í–ˆë‹¤. ì›¹ ì•±ì—ì„œëŠ” Supabase SDKê°€ ìë™ìœ¼ë¡œ í† í°ì„ ê°±ì‹ í•´ì£¼ì§€ë§Œ, Chrome Extensionì˜ content script í™˜ê²½ì—ì„œëŠ” ê·¸ëŸ° ë©”ì»¤ë‹ˆì¦˜ì´ ì‘ë™í•˜ì§€ ì•Šì•˜ë‹¤.

ìœ„ ì„¸ê°€ì§€ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… ìƒí™©ê³¼ ì§ê²°ë˜ì–´ ìˆëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê·¼ë³¸ì ì¸ ì§ˆë¬¸ë“¤ì´ ì´ì–´ì„œ ë– ì˜¬ëë‹¤.

- RLSëŠ” `auth.uid()`ë¥¼ ìš”êµ¬í•˜ëŠ”ë°, ì´ê²Œ ì–´ë–»ê²Œ ì „ë‹¬ë˜ê³  ìˆì§€?
- Next.jsì˜ `SSR/CSR` í™˜ê²½ì—ì„œ ì„¸ì…˜ì„ ìœ ì§€í•˜ëŠ” `best practice`ëŠ” ë­˜ê¹Œ?
- `Chrome Extension`ì€ ë¸Œë¼ìš°ì €ì™€ ë‹¤ë¥¸ í™˜ê²½ì¸ë°, `í† í° ê°±ì‹ `ì€ ì–´ë–»ê²Œ ì²˜ë¦¬í•´ì•¼ í•˜ì§€?

ì´ ë¬¸ì œë“¤ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ê·¼ë³¸ ì›ì¸ì„ ë¶„ì„í•´ë³´ì.

## 2ï¸âƒ£ ì–´ë–»ê²Œ í•´ê²°í•´ì•¼í• ê¹Œ

### ì‚¬ì „ ì§€ì‹

#### anon_keyì™€ service role keyì˜ ê¶Œí•œ ì°¨ì´

Supabaseë¥¼ ì²˜ìŒ ì ‘í•˜ë©´ `anon_key`ë¥¼ í´ë¼ì´ì–¸íŠ¸ `ì¸ì¦ í‚¤`ì²˜ëŸ¼ ìƒê°í•˜ê¸° ì‰½ë‹¤. í•˜ì§€ë§Œ `anon_key`ëŠ” ë‹¨ìˆœí•œ **í´ë¼ì´ì–¸íŠ¸ ì‹ë³„ìš© public key**ì¼ ë¿ì´ë‹¤.

[supabase ê³µì‹ ë¬¸ì„œ - anon and publishable keys](https://supabase.com/docs/guides/api/api-keys#anon-and-publishable-keys)

> ğŸ’¡ **Supabase anon_keyë€?**
>
> Supabaseì—ì„œ ì œê³µí•˜ëŠ” ê³µê°œ í‚¤ë¡œ, í´ë¼ì´ì–¸íŠ¸ê°€ Supabase ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ë•Œ ì‚¬ìš©í•œë‹¤. "ìµëª…(anonymous)" í‚¤ë¼ëŠ” ì´ë¦„ì´ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì…ì¥ê¶Œì¼ ë¿ì´ê³  ìŠˆí¼í‚¤ê°€ ì•„ë‹ˆë‹¤. ë§Œì•½ í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ì—ì„œ í•´ë‹¹ í‚¤ë¥¼ íƒˆì·¨í•˜ê³  ëˆ„êµ¬ë‚˜ ì´ í‚¤ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆëŠ” ìƒí™©ì´ ë°œìƒí•˜ê²Œ ëœë‹¤ë©´ ì´ëŠ” ì‹¬ê°í•œ ë³´ì•ˆ ìœ„í˜‘ì´ ë  ìˆ˜ ìˆë‹¤.
> ê·¸ëŸ¬ë¯€ë¡œ ì‹¤ì œ ê¶Œí•œì€,
>
> - ğŸ”‘ **JWT (access token)** - ì‚¬ìš©ìë¥¼ ì‹ë³„
> - ğŸ”’ **RLS ì •ì±…** - ë°ì´í„° ì ‘ê·¼ ì œì–´
> - ğŸ§  **ì„œë²„ ë¡œì§** - ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦
>   ì—ì„œ ë¶€ì—¬í•´ì•¼ í•œë‹¤.

> ğŸ’¡ **RLS(Row Level Security)ë€?**
>
> ë°ì´í„°ë² ì´ìŠ¤ì˜ ê° í–‰(row)ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ì‚¬ìš©ìë³„ë¡œ ì œì–´í•˜ëŠ” PostgreSQLì˜ ë³´ì•ˆ ê¸°ëŠ¥ì´ë‹¤.

RLSê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œëŠ” `anon_key`ë§Œ ê°€ì§€ê³ ëŠ” DBì— ì•„ë¬´ ì‘ì—…ë„ ìˆ˜í–‰í•  ìˆ˜ ì—†ë‹¤. (ê¸°ë³¸ê°’: ëª¨ë“  ì ‘ê·¼ ê¸ˆì§€)

ë°˜ë©´ì—, `service role key`ì˜ ê²½ìš°ëŠ” ìŠˆí¼ìœ ì € ê¶Œí•œì„ ê°€ì§€ë©°, RLS ì •ì±…ì„ ì™„ì „íˆ ìš°íšŒí•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ë¹„êµì  ì•ˆì „í•œ ë°±ì—”ë“œì—ì„œ `service role key`ë¥¼ ì‚¬ìš©í•˜ì—¬ RLSë¥¼ ìš°íšŒí•˜ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ìµœì¢… ê¶Œí•œ ê²€ì¦ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ ì•ˆì „í•œ íŒ¨í„´ì´ë‹¤.

ì• ì´ˆì— RLS ì •ì±…ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ê°€, ë³´ì•ˆ ê³„ì¸µì„ í•œë‹¨ê³„ ë” ë§Œë“¤ì–´ í´ë¼ì´ì–¸íŠ¸ê°€ `anon_key`ë¥¼ íƒˆì·¨í•˜ë”ë¼ë„ ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•¨ì´ê¸° ë•Œë¬¸ì´ë‹¤.

ê·¸ë˜ì„œ ë‚˜ëŠ” `Nest.js` ì„œë²„ ë‹¨ì—ì„œ service role keyë¥¼ ì‚¬ìš©í•˜ê³ , DB ì ‘ê·¼ ì—†ì´ supabaseì¸ì¦ apiì— ì ‘ê·¼í•˜ëŠ” `Next.js` ë‹¨ì—ì„œëŠ” `anon_key`ë¡œë§Œ `supabase client`ë§Œ ìƒì„±í–ˆë‹¤.
(í† í° ê²€ì¦ë¡œì§ì´ `Nest.js` ì„œë²„ ë‹¨ì— ìˆëŠ” ê²ƒì´ ì•„ë‹Œ, `Supabase Auth`ì— ìœ„ì„ë˜ì–´ ìˆìŒ)

#### ì„œë¹„ìŠ¤ RLS ì •ì±…

ê·¸ë¦¬ê³  RLS ì •ì±…ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í–ˆë‹¤.

```
USING (auth.uid() = user_id);
```

auth.uid()ëŠ” JWT ì„¸ì…˜ì—ì„œ ìœ ì € IDë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ì´ë‹¤. ì¦‰, ë‚´ê°€ ì„¤ì •í–ˆë˜ RLS ì •ì±…ì€ "í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ìì˜ IDì™€ í–‰ì˜ user_idê°€ ì¼ì¹˜í•  ë•Œë§Œ ì ‘ê·¼ì„ í—ˆìš©"í•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

### ì²«ë²ˆì§¸ ê·¼ë³¸ ì›ì¸: í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì˜ ì„¸ì…˜ ì¼ê´€ì„± ë¬¸ì œ

RLS ë³´ì•ˆì„ í‚¤ë‹ˆê¹Œ Next.js í´ë¼ì´ì–¸íŠ¸ì—ì„œ `permission denied` ì—ëŸ¬ê°€ ë°œìƒí–ˆë˜ ê·¼ë³¸ ì›ì¸ì„ ë¶„ì„í•´ë³´ì.

RLS ì •ì±…ì—ì„œ ì‚¬ìš©í•˜ëŠ” `auth.uid()`ëŠ” Supabase clientì— **JWT ì„¸ì…˜ì´ ë¶™ì–´ ìˆì–´ì•¼ë§Œ** ì¡´ì¬í•œë‹¤. ì•„ë˜ëŠ” permission denied ë¬¸ì œê°€ ë°œìƒí•œ Next.js í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì— Supabse clientë¥¼ ìƒì„±í•˜ëŠ” ì½”ë“œì˜ ì˜ˆì‹œì´ë‹¤.

```javascript
// ì˜ˆì‹œ
export function createClient() {
  return createBrowserClient(url, anon_key) // âŒ
}
```

ì´ë ‡ê²Œ ë˜ë©´ ë Œë”ë§ í•  ë–„ë§ˆë‹¤ ë§¤ë²ˆ ìƒˆë¡œìš´ Supabase client ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ëœë‹¤.
ì´ì— ë”°ë¼ ê° clientëŠ” ë…ë¦½ì ì¸ auth context ê°€ì§€ê²Œ ë˜ì–´ ë¡œê·¸ì¸ ì„¸ì…˜ì´ ìˆì–´ë„, ìƒˆ clientëŠ” ì´ë¥¼ ì•Œì§€ ëª»í•˜ê²Œ ëœë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ `auth.uid()` = `null` â†’ RLS ì¡°ê±´ ë¶ˆë§Œì¡± â†’ permission denied ì—ëŸ¬ê°€ ë°œìƒí•œ ê²ƒì´ì—ˆë‹¤.

> ğŸ’¡ **Supabaseì—ì„œì˜ ì„¸ì…˜ ê´€ë¦¬**
>
> SupabaseëŠ” ì„¸ì…˜ì„ localStorageì™€ ë©”ëª¨ë¦¬ì— ìœ ì§€í•˜ë©°, **ê°™ì€ client ì¸ìŠ¤í„´ìŠ¤ì—ì„œ auth ìƒíƒœë¥¼ ì¶”ì **í•œë‹¤.

ê·¸ëŸ¬ë¯€ë¡œ ì„¸ì…˜ ì¼ê´€ì„± ìœ ì§€ë¥¼ ìœ„í•´ì„œëŠ” ë‹¤ìŒ ì›ì¹™ì„ ì§€ì¼œì•¼ í•œë‹¤.

```
í•˜ë‚˜ì˜ ì‚¬ìš©ì ì„¸ì…˜ = í•˜ë‚˜ì˜ Supabase client
```

í•´ê²°ì±…ì€ ê°„ë‹¨í–ˆë‹¤. Supabase clientë¥¼ `ì‹±ê¸€í†¤ íŒ¨í„´`ìœ¼ë¡œ ë§Œë“¤ì–´,
ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì—ì„œ ë™ì¼í•œ client ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í–ˆë‹¤.

```javascript
// ì‹±ê¸€í†¤ íŒ¨í„´ì˜ ì˜ˆì‹œ
let browserClient: SupabaseClient | null = null

export function createClient() {
  if (typeof window === "undefined") {
    return createBrowserClient(url, anon_key)
  }

  if (browserClient) return browserClient // âœ… ì¬ì‚¬ìš©

  browserClient = createBrowserClient(url, anon_key)
  return browserClient
}
```

### ë‘ë²ˆì§¸ ê·¼ë³¸ ì›ì¸: ì„œë²„ ì»´í¬ë„ŒíŠ¸ì˜ ì„¸ì…˜ ê´€ë¦¬ ë¬¸ì œ

> SSR í™˜ê²½ì—ì„œ Supabase ì„¸ì…˜ì„ ì–´ë–»ê²Œ ìœ ì§€í•´ì•¼ í• ê¹Œ?

Next.jsì˜ SSR í™˜ê²½ì—ì„œëŠ” ë¸Œë¼ìš°ì € í™˜ê²½ì— ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì—, ì¿ í‚¤ ê¸°ë°˜ìœ¼ë¡œ Supabase clientë¥¼ ìƒì„±í•´ì•¼ í•˜ê³ , ë‹¹ì—°íˆ í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì™€ëŠ” ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì„¸ì…˜ì„ ìœ ì§€í•´ì•¼ í•œë‹¤.

ê¸°ì¡´ì—ëŠ” ì„¸ì…˜ì„ getAccessToken() ì•ˆì—ì„œ ì¡°íšŒë§Œ í–ˆë‹¤. ë„ˆë¬´ ì‰½ê²Œ ê°±ì‹ ì´ ì•Œì•„ì„œ ë˜ê² ê±°ë‹ˆì™€ ìƒê°ì„ í–ˆë–¤ ê±° ê°™ë‹¤. í•˜ì§€ë§Œ ì´ëŸ´ ê²½ìš° `Next.js ì„œë²„` ë‹¨ì—ì„œ í† í°ì´ ë§Œë£Œë˜ì–´ë„ ì„¸ì…˜ì„ ê°±ì‹ í•˜ì§€ ì•Šê²Œ ë˜ë¯€ë¡œ, ì˜ˆì™¸ìƒí™©ì´ ë°œìƒí–ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´, ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œëŠ” í† í°ì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ ì‚¬ì „ì— í™•ì¸í•˜ê³ , ë§Œë£Œë˜ì—ˆê±°ë‚˜ ê³§ ë§Œë£Œë  ì˜ˆì •ì´ë¼ë©´ ë¯¸ë¦¬ ê°±ì‹ í•˜ëŠ” ë¡œì§ì´ í•„ìš”í•˜ë‹¤. ê·¸ë˜ì„œ ë‚˜ëŠ” í† í°ì„ ì¿ í‚¤ë¥¼ í†µí•´ êº¼ë‚¼ ë–„ í•´ë‹¹ í† í°ì˜ ë§Œë£Œ ì˜ˆì • ì‹œê°ì„ í™•ì¸í•˜ì—¬, í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ê³§ ë§Œë£Œë  ì˜ˆì •ì´ë¼ë©´ `refreshSession()`ì„ í˜¸ì¶œí•˜ì—¬ í† í°ì„ ê°±ì‹ í•˜ë„ë¡ ë³€ê²½í–ˆë‹¤.

### ì„¸ë²ˆì§¸ ê·¼ë³¸ ì›ì¸: Extensionì˜ content script í™˜ê²½

> ìœ ì €ì˜ Extension í™˜ê²½ì—ì„œ Supabase ì„¸ì…˜ì„ ì–´ë–»ê²Œ ìœ ì§€í•´ì•¼ í• ê¹Œ?

ë¸Œë¼ìš°ì € ì „ì—­ì—ì„œ ì €ì¥í•  ìˆ˜ ìˆëŠ” ê³µê°„ì´ ë­ê°€ ìˆì„ê¹Œ ì°¾ì•„ë³´ë‹¤ê°€, `chrome.storage.local` ì´ë¼ëŠ” ê³µê°„ì´ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œê²Œ ë˜ì—ˆë‹¤.

í•˜ì§€ë§Œ ë¸Œë¼ìš°ì € í™˜ê²½ê³¼ëŠ” ë‹¤ë¥´ê²Œ, Chrome Extensionì˜ content script í™˜ê²½ì—ì„œëŠ” Supabase SDKì˜ ìë™ ê°±ì‹  ë©”ì»¤ë‹ˆì¦˜ì´ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤. supabase sdkëŠ” ë¸Œë¼ìš°ì €ì˜ `localStorage`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ì„ ê´€ë¦¬í•˜ëŠ”ë°, content scriptëŠ” ë¸Œë¼ìš°ì €ì˜ localStorageì™€ ì™„ì „íˆ ë¶„ë¦¬ë˜ì–´ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì„¸ì…˜ ê°±ì‹ ì„, ì£¼ê¸°ì ìœ¼ë¡œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì´ í•„ìš”í•˜ê² ë‹¤.

## 4ï¸âƒ£ í™˜ê²½ë³„ í† í° ê°±ì‹  ì „ëµ

ìœ„ì—ì„œì˜ ê³ ë¯¼ì„ ë°”íƒ•ìœ¼ë¡œ í™•ë¦½í•œ ì„œë²„, í´ë¼ì´ì–¸íŠ¸, Extension í™˜ê²½ë³„ í† í° ê°±ì‹  ì „ëµì„ ì •ë¦¬í–ˆë‹¤.

### Server: Proactive Refresh

ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œëŠ” **API í˜¸ì¶œ ì „ì— í† í°ì„ ë¯¸ë¦¬ ê°±ì‹ **í•œë‹¤.

```javascript
export async function getAccessToken() {
  const supabase = createClient() // createServerClient (ì¿ í‚¤ ê¸°ë°˜)
  const {
    data: { session },
  } = await supabase.auth.getSession()

  if (!session) return null

  const expiresAt = new Date(session.expires_at * 1000)
  const now = new Date()

  // ë§Œë£Œëê±°ë‚˜ 60ì´ˆ ì´ë‚´ë©´ ê°±ì‹ 
  if (expiresAt.getTime() - now.getTime() < 60000) {
    const {
      data: { session: newSession },
    } = await supabase.auth.refreshSession()
    return newSession?.access_token ?? null
  }

  return session.access_token
}
```

#### ë™ì‘ ì›ë¦¬

- ë§Œë£Œ ì—¬ë¶€ë¥¼ `expires_at`ìœ¼ë¡œ ì‚¬ì „ í™•ì¸
- ë§Œë£Œ ì „ì— ë¯¸ë¦¬ ê°±ì‹ 
- API í˜¸ì¶œ ì‹œ í•­ìƒ ìœ íš¨í•œ í† í° ì‚¬ìš©

### Client: Reactive Refresh

í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œëŠ” ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œ ì‹œ **401 ì‘ë‹µì„ ë°›ì€ í›„ì— ê°±ì‹ **í•œë‹¤.

```javascript
async function fetchWithRefreshMiddleware(url, options) {
  const supabase = createClient() // createBrowserClient
  const {
    data: { session },
  } = await supabase.auth.getSession()

  // ì²« ìš”ì²­
  let response = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      Authorization: `Bearer ${session.access_token}`,
    },
  })

  // 401ì´ë©´ ì¬ì‹œë„
  if (response.status === 401) {
    await supabase.auth.refreshSession()
    const {
      data: { session: newSession },
    } = await supabase.auth.getSession()

    response = await fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        Authorization: `Bearer ${newSession.access_token}`,
      },
    })
  }

  return response
}
```

##### ë™ì‘ ì›ë¦¬

- ë§Œë£Œ ì—¬ë¶€ í™•ì¸ ì—†ì´ ì¼ë‹¨ ìš”ì²­
- 401 ì‘ë‹µ ì‹œ ê°±ì‹  (reactive)
- ê°™ì€ ìš”ì²­ ì¬ì‹œë„

**ì„œë²„ vs í´ë¼ì´ì–¸íŠ¸ ë¹„êµ**

| êµ¬ë¶„          | ì„œë²„ ì»´í¬ë„ŒíŠ¸                            | í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸                    |
| ------------- | ---------------------------------------- | -------------------------------------- |
| ë¦¬í”„ë ˆì‹œ ì‹œì  | API í˜¸ì¶œ ì „ (ë§Œë£Œ/60ì´ˆ ì´ë‚´ë©´ ë¯¸ë¦¬ ê°±ì‹ ) | API í˜¸ì¶œ í›„ 401 ë°œìƒ ì‹œ ê°±ì‹  í›„ ì¬ì‹œë„ |
| ë§Œë£Œ íŒë‹¨     | `expires_at vs now + 60`                 | ì‚¬ìš© ì•ˆ í•¨ (401ë¡œ íŒë‹¨)                |
| ë°©ì‹          | Proactive (ì˜ˆë°©ì )                       | Reactive (ëŒ€ì‘ì )                      |
| í† í° ì €ì¥     | ì¿ í‚¤ (`cookies()`)                       | ë¸Œë¼ìš°ì € ìŠ¤í† ë¦¬ì§€                      |

### Extension: Background Alarm

Chrome Extensionì—ì„œëŠ” background alarm ê¸°ëŠ¥ì„ í†µí•´ ë¸Œë¼ìš°ì €ì˜ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì£¼ê¸°ì ì¸ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

##### chrome.alarms ì‚¬ìš©

```javascript
// background.js - ì•ŒëŒ ë“±ë¡
chrome.alarms.create("refreshToken", {
  periodInMinutes: 50,
})

// ì•ŒëŒ ë¦¬ìŠ¤ë„ˆ
chrome.alarms.onAlarm.addListener(async alarm => {
  if (alarm.name !== "refreshToken") return

  const { refreshToken } = await chrome.storage.local.get([REFRESH_TOKEN_KEY])
  if (!refreshToken) return

  try {
    const newAccessToken = await refreshAccessToken(refreshToken)
    await chrome.storage.local.set({
      [ACCESS_TOKEN_KEY]: newAccessToken,
    })
  } catch (error) {
    console.error("Token refresh failed:", error)
  }
})
```

##### ë™ì‘ ì›ë¦¬

- Supabase access token ë§Œë£Œ: 1ì‹œê°„
- ì•ŒëŒ ì£¼ê¸°: 50ë¶„ (ë§Œë£Œ ì „ì— ê°±ì‹ )
- ì‚¬ìš©ì ì•¡ì…˜ ë¶ˆí•„ìš” (ìë™ ê°±ì‹ )
- Manifest V3 service workerë„ ì•ŒëŒ ì‹œì ì— ê¹¨ì–´ë‚¨

## 5ï¸âƒ£ ìµœì¢… êµí›ˆ

### 1. ì„¸ì…˜ ì¼ê´€ì„± ì§€í‚¤ê¸°

```
í•˜ë‚˜ì˜ ì‚¬ìš©ì ì„¸ì…˜ = í•˜ë‚˜ì˜ Supabase client
```

clientë¥¼ ë§¤ë²ˆ ìƒˆë¡œ ìƒì„±í•˜ë©´:

- ë¡œê·¸ì¸ ì„¸ì…˜ì´ ìˆì–´ë„
- Supabase ë‚´ë¶€ auth contextëŠ” ë¦¬ì…‹

**í•´ê²°: Client `ì‹±ê¸€í†¤ íŒ¨í„´`**

### 2. í™˜ê²½ë³„ ì„¸ì…˜ ê´€ë¦¬ ë°©ë²•ì˜ ì°¨ì´

| í™˜ê²½             | í† í° ì €ì¥         | ê°±ì‹  ì „ëµ           | ê°±ì‹  ì‹œì                   |
| ---------------- | ----------------- | ------------------- | -------------------------- |
| Server Component | ì¿ í‚¤              | Proactive           | API í˜¸ì¶œ ì „ (ë§Œë£Œ 60ì´ˆ ì „) |
| Client Component | ë¸Œë¼ìš°ì € ìŠ¤í† ë¦¬ì§€ | Reactive            | 401 ì‘ë‹µ í›„                |
| Chrome Extension | chrome.storage    | Background Periodic | 50ë¶„ë§ˆë‹¤ ìë™              |

### 3. Supabase ë³´ì•ˆ ì„¤ì •

```tx
1ë‹¨ê³„: Client (anon_key + JWT)
  2ë‹¨ê³„: â†’ Server (JWT ê²€ì¦ + ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
    3ë‹¨ê³„: â†’ DB (RLS ì •ì±…)
```
