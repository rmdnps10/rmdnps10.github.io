{"componentChunkName":"component---src-templates-blog-post-js","path":"/[트러블슈팅] Supabase를 활용한 인증, 인가/","result":{"data":{"site":{"siteMetadata":{"title":"메인","siteUrl":"https://inyoung.dev","author":{"name":"Inyoung Chung"}}},"allMarkdownRemark":{"nodes":[{"fields":{"slug":"/[트러블슈팅] Supabase를 활용한 인증, 인가/"},"frontmatter":{"title":"[트러블슈팅] Supabase Auth를 활용한 다양한 환경에서의 세션 유지","date":"2026-02-10","tags":["Web","회고"],"pointColor":"#3ECF8D"}},{"fields":{"slug":"/waterfall-agile/"},"frontmatter":{"title":"[소프트웨어공학] Waterfall과 Agile","date":"2026-02-03","tags":["소프트웨어공학"],"pointColor":"#ffffff"}},{"fields":{"slug":"/os-file-system/"},"frontmatter":{"title":"[운영체제] 파일 시스템","date":"2026-01-27","tags":["운영체제"],"pointColor":"#ffffff"}},{"fields":{"slug":"/os-virtual-memory/"},"frontmatter":{"title":"[운영체제] 5. 가상 메모리","date":"2026-01-26","tags":["운영체제"],"pointColor":"#ffffff"}},{"fields":{"slug":"/os-cpu-scheduling/"},"frontmatter":{"title":"[운영체제] 4. CPU 스케줄링","date":"2026-01-25","tags":["운영체제"],"pointColor":"#ffffff"}},{"fields":{"slug":"/os-synchronization-deadlock/"},"frontmatter":{"title":"[운영체제] 3. 동기화와 교착 상태","date":"2026-01-24","tags":["운영체제"],"pointColor":"#ffffff"}},{"fields":{"slug":"/os-process-thread/"},"frontmatter":{"title":"[운영체제] 2. 프로세스와 스레드","date":"2026-01-23","tags":["운영체제"],"pointColor":"#ffffff"}},{"fields":{"slug":"/os-big-picture/"},"frontmatter":{"title":"[운영체제] 1. 운영체제의 큰 그림","date":"2026-01-21","tags":["운영체제"],"pointColor":"#ffffff"}},{"fields":{"slug":"/computer-architecture-cpu/"},"frontmatter":{"title":"[컴퓨터구조] 3. CPU","date":"2026-01-18","tags":["컴퓨터구조"],"pointColor":"#ffffff"}},{"fields":{"slug":"/computer-architecture-computer-information/"},"frontmatter":{"title":"[컴퓨터구조] 2. 컴퓨터가 이해하는 정보","date":"2026-01-17","tags":["컴퓨터구조"],"pointColor":"#ffffff"}},{"fields":{"slug":"/computer-architecture-big-picture/"},"frontmatter":{"title":"[컴퓨터구조] 1. 컴퓨터구조의 큰 그림","date":"2026-01-15","tags":["컴퓨터구조"],"pointColor":"#ffffff"}},{"fields":{"slug":"/java-coding-test-grammer/"},"frontmatter":{"title":"Java 코딩테스트 문법 최종 정리","date":"2026-01-08","tags":["알고리즘"],"pointColor":"#ed8b00"}},{"fields":{"slug":"/lg-webos-tv-fullstack-appliaction/"},"frontmatter":{"title":"WebOS TV에 들어갈 풀스택 애플리케이션을 만들어보자 (LG전자 산학 프로젝트 후기)","date":"2025-12-22","tags":["회고"],"pointColor":"#ffffff"}},{"fields":{"slug":"/algorithm-maximum-flow/"},"frontmatter":{"title":"알고리즘설계와분석 - 최대 유량 문제 (Maximum Flow)","date":"2025-12-16","tags":["알고리즘"],"pointColor":"#ffffff"}},{"fields":{"slug":"/algorithm-shortest-path/"},"frontmatter":{"title":"알고리즘설계와분석 - 최단경로 (Shortest Path)","date":"2025-12-13","tags":["알고리즘"],"pointColor":"#ffffff"}},{"fields":{"slug":"/algorithm-minimum-spanning-tree/"},"frontmatter":{"title":"알고리즘설계와분석 - MST (최소신장트리)","date":"2025-12-12","tags":["알고리즘"],"pointColor":"#ffffff"}},{"fields":{"slug":"/algorithm-bfs-dfs/"},"frontmatter":{"title":"알고리즘설계와분석 - BFS/DFS와 Topological Sort","date":"2025-12-11","tags":["알고리즘"],"pointColor":"#ffffff"}},{"fields":{"slug":"/algorithm-greedy-algorithm/"},"frontmatter":{"title":"알고리즘설계와분석 - Greedy algorithm (그리디 알고리즘)","date":"2025-12-10","tags":["알고리즘"],"pointColor":"#ffffff"}},{"fields":{"slug":"/algorithm-dynamic-programming/"},"frontmatter":{"title":"알고리즘설계와분석 - Dynamic Programming (동적 계획법)","date":"2025-12-07","tags":["알고리즘"],"pointColor":"#ffffff"}},{"fields":{"slug":"/algorithm-binary-search-tree/"},"frontmatter":{"title":"알고리즘설계와분석 - Binary Search Tree (이진 탐색 트리)","date":"2025-12-05","tags":["알고리즘"],"pointColor":"#ffffff"}},{"fields":{"slug":"/database-system-erd/"},"frontmatter":{"title":"데이터베이스 시스템 개론 📚 - Chapter2. ERD로 데이터베이스 설계하기","date":"2025-10-05","tags":["DB"],"pointColor":"#ffffff"}},{"fields":{"slug":"/make-huggingface-pipeline/"},"frontmatter":{"title":"허깅페이스로 파이프라인을 만들어보자 - 트랜스포머 모델 활용 가이드","date":"2025-10-04","tags":["AI"],"pointColor":"#FF9A00"}},{"fields":{"slug":"/rag-core-concept/"},"frontmatter":{"title":"RAG의 핵심 개념과 실습","date":"2025-10-01","tags":["AI"],"pointColor":"#FF6B6B"}},{"fields":{"slug":"/prompt-engineering-basic/"},"frontmatter":{"title":"프롬프트 엔지니어링 기초 - AI와 효과적으로 소통하는 방법","date":"2025-09-28","tags":["AI"],"pointColor":"#ffffff"}},{"fields":{"slug":"/how-to-use-flutter-riverpod/"},"frontmatter":{"title":"초심자 입장에서 Flutter Riverpod을 '잘' 사용하는 방법 (장문)","date":"2025-09-20","tags":["Flutter"],"pointColor":"#0468d7"}},{"fields":{"slug":"/database-system-introduction/"},"frontmatter":{"title":"데이터베이스 시스템 개론 📚 – Chapter 1. Introduction of Database Systems","date":"2025-09-16","tags":["DB"],"pointColor":"#ffffff"}},{"fields":{"slug":"/kakaobank-devrel-internship-retrospect/"},"frontmatter":{"title":"서비스 개발부터 DevRel까지: 카카오뱅크 인턴쉽 회고","date":"2025-07-28","tags":["인턴","회고","카카오뱅크","네이버랩스"],"pointColor":"#ffe300"}},{"fields":{"slug":"/my-it-startup-internship-retrospect/"},"frontmatter":{"title":"나의 IT 스타트업 인턴쉽 회고","date":"2025-03-14","tags":["인턴","회고"],"pointColor":"#6FE7FF"}},{"fields":{"slug":"/sogang-likelion-management-retrospect/"},"frontmatter":{"title":"서강대학교 멋쟁이사자처럼 운영진 회고","date":"2025-02-27","tags":["멋쟁이사자처럼","회고"],"pointColor":"#FD7911"}}]},"markdownRemark":{"id":"cca09ce6-a2ec-51d7-8e07-d9e9c42f230e","excerpt":"최근에 사이드 프로젝트로 BOJ AI Helper라는 서비스를 개발하고 있습니다. Nest.js 서버, Next.js SSR&CSR, Chrome Extension 환경에서 Supabase Auth…","html":"<blockquote>\n<p>최근에 사이드 프로젝트로 <strong>BOJ AI Helper</strong>라는 서비스를 개발하고 있습니다.</p>\n<p>Nest.js 서버, Next.js SSR&#x26;CSR, Chrome Extension 환경에서 Supabase Auth를 통합하며 몇가지 인증 에러들을 만났고, 이러한 에러를 맞닥뜨리며 인증/인가 아키텍처를 설계한 과정을 기록합니다.</p>\n</blockquote>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"background: transparent;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d821cbfac89975d43751a1b01678ca2e/d5c41/home-ui.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.599999999999994%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABI0lEQVR42p2S6W6DMBCEfR+QFDAyheA0h5RGfZpGef93ma7JUVWRKpIfn8Baa3Zn1qxpAmKMsNaCMTabfN8aA601vHWw2sB7DyaEQEoJu90OSqlZYmVZ3u/yjLfQ9ZL+OVgurFYjQmhhqOMcwRDC3ZEgVOpgP7eXOucCfT9ivz/gePyavjH2aNvugUiN66ZFURR0biGlvE8pbg2z5WFIWK+3E+P4ga4bHshNxrShnEqcz2d8n07XLA0U5ShvcXHOp/Gd87MzDE2DuqovlslhdpkHu9bZdMhk8TmCipZQbRLcEMGshtEW5WLxK/gsclnAHDaQ+xGiKkmQno93rwvmdxfJ8hu9Oy3VlOEfy89incN73yPQpvO289az6MuC/zJ3s3P5AbpNADTUAyo3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d821cbfac89975d43751a1b01678ca2e/bc904/home-ui.webp 250w,\n/static/d821cbfac89975d43751a1b01678ca2e/4be29/home-ui.webp 500w,\n/static/d821cbfac89975d43751a1b01678ca2e/03f31/home-ui.webp 1000w,\n/static/d821cbfac89975d43751a1b01678ca2e/9579c/home-ui.webp 1500w,\n/static/d821cbfac89975d43751a1b01678ca2e/b1218/home-ui.webp 2000w,\n/static/d821cbfac89975d43751a1b01678ca2e/d8c3c/home-ui.webp 2574w\"\n              sizes=\"(max-width: 1000px) 100vw, 1000px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d821cbfac89975d43751a1b01678ca2e/43fa5/home-ui.png 250w,\n/static/d821cbfac89975d43751a1b01678ca2e/c6e3d/home-ui.png 500w,\n/static/d821cbfac89975d43751a1b01678ca2e/da8b6/home-ui.png 1000w,\n/static/d821cbfac89975d43751a1b01678ca2e/2e9ed/home-ui.png 1500w,\n/static/d821cbfac89975d43751a1b01678ca2e/9fabd/home-ui.png 2000w,\n/static/d821cbfac89975d43751a1b01678ca2e/d5c41/home-ui.png 2574w\"\n            sizes=\"(max-width: 1000px) 100vw, 1000px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d821cbfac89975d43751a1b01678ca2e/da8b6/home-ui.png\"\n            alt=\"BOJ AI Helper를 개발하며 맞닥뜨린 트러블슈팅을 기록합니다.\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">BOJ AI Helper를 개발하며 맞닥뜨린 트러블슈팅을 기록합니다.</figcaption>\n  </figure></p>\n<h2 id=\"프로젝트boj-ai-helper-배경\">프로젝트(BOJ AI Helper) 배경</h2>\n<h3 id=\"학습-과정의-누락된-부분\">학습 과정의 누락된 부분</h3>\n<p>백준 온라인 저지는 문제를 풀고 제출하면 \"맞았습니다\" 또는 \"틀렸습니다\" 결과를 제공한다. 하지만 제출 이후의 학습 과정은 사용자에게 전적으로 맡겨져 있다.</p>\n<p><strong>백준 플랫폼의 한계</strong></p>\n<ul>\n<li>제출 내역은 채점 결과만 표시</li>\n<li>풀이 과정이나 사고 방식은 기록되지 않음</li>\n<li>복습 시점을 사용자가 직접 관리해야 함</li>\n<li>반복되는 실수 패턴을 파악하기 어려움</li>\n</ul>\n<p>일주일 전에 풀었던 문제를 다시 보면 어떻게 풀었는지 기억나지 않는 경우가 많다.\n단순히 <code class=\"language-text\">solved.ac</code> 티어를 높이기 위해서, 문제를 많이 푸는 것만으로는 실질적인 코딩 테스트를 통과하기 위한 실력을 쌓기는 어렵다.</p>\n<h3 id=\"제출을-학습-이벤트로\">제출을 학습 이벤트로</h3>\n<p>BOJ AI Helper는 백준의 제출을 단순한 채점 요청이 아니라 <code class=\"language-text\">하나의 학습 이벤트</code>로 바라본다.</p>\n<p>하나의 코드 제출에는 많은 정보들이 담겨 있다.</p>\n<ul>\n<li><strong>틀린 제출</strong>: 어떤 부분을 오해했는지, 어떤 엣지 케이스를 놓쳤는지..</li>\n<li><strong>맞은 제출</strong>: 그 시점의 사고 방식, 선택한 알고리즘과 자료구조가 적절했는지..</li>\n</ul>\n<p>사람마다 코테를 준비하기 위한 코드를 작성할 때 공통적으로 실수하는 패턴이나 본인의 취약점이 존재한다.\n이러한 데이터를 체계적으로 수집하고 분석하면 개인화된 학습 피드백을 제공하는 것이 가능하다는 시나리오에서, 개발을 시작하게 됐다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"background: transparent;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d7c2df29275924faf164a405eed01c44/9bdaf/detail-ui.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACBElEQVR42nVT2W7bMBCkE7m1XVv3RZ2UKFmWq8KJXeSlAYoWfe839P8/YrpLQ0YQOA8LUiR3dmZ2JWzbhpQSu90OQgg8PCywWCzMntd7wXfr9RrrzQar1Qrb7RabzRezCr5wXReO48ANJD5vXCytJT1cw6J1jsdH67ZfLj8hCCJ4aQw/ipAmEmmaEU4AkaY5np5f0DQduh//UDz9pQcx2m5AkmTgew4pCxPzPgwTZFmB/X6EUhpt2yOVJYQflyi7C9K8MQBhkCAiCzKlbslZVqKjAkVRmzP+ZoZVWeH3rz+4XF5wOp1RlgqCK2m9R98PGIYjJFWVlNT3B8SxvLHM88rs52/fDw3A6+tPnM/fCfCCqmogHMclFjmiKKHHEp7ng8/iOKXVM75cw7/tPS+kJjoGtKoUAddkmTYEBAOwF/yAAXY724DrhiQSg9m3t8FnQRAbQKVak+/7EWzb5QkQeB8+MahLbQBTSp6lvpXMgAw0jt/Iqq9k0WgK3QX0/ACq0mjIk6qgKBsoklVTgYYkKoqYVLD/3Czu8BUw/4AhARZ5jVH3OO576H7COIw47I9kBSXrjhonjTWHw2RGZxwnalz5AWAQkpzKsOkaYtQOFAc0xIRZJMlVMjdxmk5G9jQ9X8fGsqw7gJGZNU2Ga2Kp6pbkViiJwTzgLJd/N26M5wVGFTf0PzGuLdCnOA1ZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d7c2df29275924faf164a405eed01c44/bc904/detail-ui.webp 250w,\n/static/d7c2df29275924faf164a405eed01c44/4be29/detail-ui.webp 500w,\n/static/d7c2df29275924faf164a405eed01c44/03f31/detail-ui.webp 1000w,\n/static/d7c2df29275924faf164a405eed01c44/9579c/detail-ui.webp 1500w,\n/static/d7c2df29275924faf164a405eed01c44/b1218/detail-ui.webp 2000w,\n/static/d7c2df29275924faf164a405eed01c44/0bff3/detail-ui.webp 2578w\"\n              sizes=\"(max-width: 1000px) 100vw, 1000px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d7c2df29275924faf164a405eed01c44/43fa5/detail-ui.png 250w,\n/static/d7c2df29275924faf164a405eed01c44/c6e3d/detail-ui.png 500w,\n/static/d7c2df29275924faf164a405eed01c44/da8b6/detail-ui.png 1000w,\n/static/d7c2df29275924faf164a405eed01c44/2e9ed/detail-ui.png 1500w,\n/static/d7c2df29275924faf164a405eed01c44/9fabd/detail-ui.png 2000w,\n/static/d7c2df29275924faf164a405eed01c44/9bdaf/detail-ui.png 2578w\"\n            sizes=\"(max-width: 1000px) 100vw, 1000px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d7c2df29275924faf164a405eed01c44/da8b6/detail-ui.png\"\n            alt=\"서비스 화면 -제출 상세 정보\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">서비스 화면 -제출 상세 정보</figcaption>\n  </figure></p>\n<h3 id=\"목표\">목표</h3>\n<p><code class=\"language-text\">BOJ AI Helper</code>는 <strong>\"문제 풀이 → AI 피드백 → 복습\"</strong> 루프를 통해, 유저가 코드 작성에 있어서 자신의 약점을 보완하고 실력을 향상시킬 수 있도록 돕는 것을 목표로 한다.</p>\n<p>현재까지 구현한 핵심 기능은 이렇다.</p>\n<ul>\n<li>제출 자동 수집: <code class=\"language-text\">Chrome Extension</code>으로 백준 제출 내역 크롤링</li>\n<li>제출 데이터 영속화: 소스 코드, 결과, 문제 정보 저장</li>\n<li>학습 데이터 관리: 메모 작성, 복습 일정 관리</li>\n</ul>\n<p>그리고 향후에 캡스톤 프로젝트 지원금을 활용해 이 기능까지 추가를 하고, 런칭을 해볼 예정이다.</p>\n<ul>\n<li>AI 기반 분석:제출 내역 기반 피드백 및 패턴 분석</li>\n</ul>\n<h2 id=\"supabase-auth의-도입\">Supabase Auth의 도입</h2>\n<p>이번 프로젝트에서는 <code class=\"language-text\">Supabase</code>를 Auth Provider로서 활용하며, 데이터 접근은 자체 백엔드 서버를 통해 수행했다.\n즉, 토큰 검증과 토큰 발급의 책임을 서버단이 아닌 <code class=\"language-text\">Supabase Auth</code>가 담당하도록 설계했다.</p>\n<h3 id=\"도입-배경\">도입 배경</h3>\n<p>예전에 참여한 AI 해커톤에서 <code class=\"language-text\">Next.js</code>로 프론트엔드 단만을 구현하며 <code class=\"language-text\">Supabase</code>를 사실상의 백엔드로서 활용한 경험이 있었는데, 당시에 직접 백엔드를 구현하지 않고 굉장히 수월하게 서비스를 만들 수 있었다.</p>\n<p>그 당시에 경험으로 이번 프로젝트에서도 <code class=\"language-text\">Supabase Auth</code>를 도입하게 되었다.</p>\n<p>하지만 이번 프로젝트는 단순한 프론트엔드 앱이 아니라, <code class=\"language-text\">Next.js</code> 풀스택 앱과 <code class=\"language-text\">NestJS</code> 백엔드 서버, 그리고 <code class=\"language-text\">Chrome Extension</code>까지 아우르는 복합적인 아키텍처였기에, <code class=\"language-text\">Supabase Auth</code>를 통합하는 과정에서 여러 가지 트러블슈팅 상황에 직면하게 되었다.</p>\n<blockquote>\n<h5>이 글에서는 <code class=\"language-text\">Supabase Auth</code>를 활용하여 풀스택 인증/인가 아키텍처를 설계하고, RLS 설정, 토큰 관리, 환경별 인증 처리 문제를 해결한 경험을 공유하고자 한다.</h5>\n</blockquote>\n<h3 id=\"인증-아키텍처-설계\">인증 아키텍처 설계</h3>\n<p>먼저 인증 아키텍처는 아래와 같은 시나리오 하에 설계했다.</p>\n<h4 id=\"인증-플로우\">인증 플로우</h4>\n<ol>\n<li>사용자가 Next.js 앱에서 Supabase Auth로 로그인</li>\n<li>Supabase가 JWT와 refresh token 발급</li>\n<li>Chrome Extension은 auth-bridge를 통해 토큰 수신</li>\n<li>모든 API 요청에 JWT 포함</li>\n<li>서버가 Supabase Auth를 통해 JWT 검증 후 DB 접근</li>\n</ol>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"background: transparent;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/58823d90edb75d40ac5fd4c4b7338a34/e4a85/flow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAACE4AAAhOAFFljFgAAAB0UlEQVR42nVTSW7bQBDU02xLMndSC6khKZFaKEVLfBBhBbAPQRSfBOQcIPmBAQP+QM75k2/lqQYoSDJ9KAxnpqe6q6vZcF0XjuPAtu0juOe5ZVnwPE/2/D6N4X0dGgzudDoIwxBKKQwGAwRBIGer1UqCoihCmqaC0WgkMZ8SMhuJsizDcDhEURSC6XSK3W6H8XiM+XyO2WwmZCT39EPTNKT6WsJ2uy1VxXEsVfARQRKuvV5PyCaTCQ6HA37/+avv5rWkDRIwsCxLkXjao6p/stdrEIX4//KMt3+veHwo0WzdwvcvCDebDfb7PbbbLZbLJfr9/gcZUoXjwg9cFOU9fv14wN0XBcPi3YVkmkE57CFBMyqXq5VglUy20klDFUPFab0p1XhUTp6OxGV/2NOB0g577qejI6bQjMViIT1klYZhYDyb4ufTkyRhwjzPj+4nSXJW/YcKfd8/SuUIkbxIUjzuviHSLWEiJmXFjJXqbEfGh2cVjoRn/dKrr8fk+5WFr9cGQsNCnMRYr9dCvNRQerCtqANbS7dME6ZWQBVnhKfE3W5XJObaLA47zeBK+VmeYaS/jYXCbeDg5uoaN80mWq1WPWEFSqskXv7rItmyayW/A9moAjD4MMYDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/58823d90edb75d40ac5fd4c4b7338a34/bc904/flow.webp 250w,\n/static/58823d90edb75d40ac5fd4c4b7338a34/4be29/flow.webp 500w,\n/static/58823d90edb75d40ac5fd4c4b7338a34/03f31/flow.webp 1000w,\n/static/58823d90edb75d40ac5fd4c4b7338a34/6740d/flow.webp 1287w\"\n              sizes=\"(max-width: 1000px) 100vw, 1000px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/58823d90edb75d40ac5fd4c4b7338a34/43fa5/flow.png 250w,\n/static/58823d90edb75d40ac5fd4c4b7338a34/c6e3d/flow.png 500w,\n/static/58823d90edb75d40ac5fd4c4b7338a34/da8b6/flow.png 1000w,\n/static/58823d90edb75d40ac5fd4c4b7338a34/e4a85/flow.png 1287w\"\n            sizes=\"(max-width: 1000px) 100vw, 1000px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/58823d90edb75d40ac5fd4c4b7338a34/da8b6/flow.png\"\n            alt=\"인증 플로우\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">인증 플로우</figcaption>\n  </figure></p>\n<p><strong>Client (Next.js / Chrome Extension)</strong></p>\n<ul>\n<li><code class=\"language-text\">anon_key</code> + Supabase Auth SDK로 JWT 발급</li>\n<li>모든 API 요청에 JWT 포함</li>\n</ul>\n<p><strong>Server (NestJS)</strong></p>\n<ul>\n<li>모든 인증 필요 API에 SupabaseAuthGuard 사용, Supabase Auth로 사용자 식별</li>\n<li><code class=\"language-text\">service_role</code> key로 DB 접근</li>\n</ul>\n<p><strong>Supabase (PostgreSQL + RLS)</strong></p>\n<ul>\n<li>Supabase Auth만 클라이언트/확장 프로그램 환경에서 직접 사용</li>\n<li>DB는 Nest(Prisma)만 사용</li>\n</ul>\n<h4 id=\"왜-이렇게-설계해야만-하나\">왜 이렇게 설계해야만 하나?</h4>\n<p>이 프로젝트는 Next.js 기반 웹 애플리케이션과 Chrome Extension이 동시에 동작하는 구조이다. 두 클라이언트가 하나의 인증 체계를 공유해야 한다.</p>\n<p>나는 아래의 원칙들을 고수하여 아키텍처를 설계했다.</p>\n<ol>\n<li>브라우저 환경에 service_role key가 노출되면 안 된다.</li>\n<li>모든 비즈니스 로직을 단일 서버를 통해 실행되어야 한다.</li>\n<li>웹 앱과 확장 프로그램이 동일한 인증 체계를 사용해야 한다. 두 환경이 서로 다른 인증 흐름을 가지면 토큰 동기화와 권한 관리가 복잡해진다.</li>\n</ol>\n<p>클라이언트는 Supabase Auth를 통해 JWT만 발급받는다.\n모든 API 요청은 해당 JWT를 포함해 서버로 전달한다.\n서버는 Supabase Auth API를 통해 JWT를 검증하고 사용자 정보를 확인한다.\n실제 DB 접근은 NestJS 서버에서만 수행한다. 이때 service_role key는 서버에만 존재한다.</p>\n<h4 id=\"서비스-전체-아키텍처\">서비스 전체 아키텍처</h4>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"background: transparent;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99246e95272d0d7a074d637d13743bb7/e4a85/architecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAACE4AAAhOAFFljFgAAAB+klEQVR42n1T227aQBT0l7UiAuM72Nj4gsFcjGsDFRChCKG+VH3ra/+kykM+pK/9lunOSR0FouRhtPbZ3Tkzs7ua4zggbNtGr9eDrutoax/BfaeutWRBEODw8ICvx3t4rgtL1dq5W7Cuew5MV83fErpqc1+pqpoGf58e8efpN6IkFQWr1QqbzQZlWaJR8/wfDoew1Z5Tx8BCtxCY9hWpEFqmhaxI8fP7Dzz++oY49hEr0jzPURSFYDabYTqdYrlcYhRFuB+EWA9HSIIRHMXxQkgLlmUhTRPkVY2ybpCpb5LEcQzTNNHv92U0DEPGSBEmqkFZf0Exn19b9jwPg8FAfmbTHE1dg6rH4wjb7VZAAjal3fV6LWDmk8kEvu9LozZbjdlwU62I2sWsMTuqpO39fi9qSUDLFECSLMukRvCb4jR2D8NQVJBgriyMx2PJjBtpl4uPxyMWi4VYJqgoSZ6jOZ1OMtKF1kplR54iJ1jjfSQhibmRNTZmZmmcyHrOsTkjcv8fjBBS6uVywfl8xuFweDld2mNG7RpH3bsoVE7qErplIFWNmCVdXF1sYrfbCaqqEiLmwmtCm8yV6hnHar6As5mi5zvofPqMzt0dut3uW0Lao2yeJME8qIxqSUTFtM78XPt5D1UT7ut7+Pot3z4vgsTtQfBb6u77b/wfl/4HQnQIqm8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/99246e95272d0d7a074d637d13743bb7/bc904/architecture.webp 250w,\n/static/99246e95272d0d7a074d637d13743bb7/4be29/architecture.webp 500w,\n/static/99246e95272d0d7a074d637d13743bb7/03f31/architecture.webp 1000w,\n/static/99246e95272d0d7a074d637d13743bb7/6740d/architecture.webp 1287w\"\n              sizes=\"(max-width: 1000px) 100vw, 1000px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/99246e95272d0d7a074d637d13743bb7/43fa5/architecture.png 250w,\n/static/99246e95272d0d7a074d637d13743bb7/c6e3d/architecture.png 500w,\n/static/99246e95272d0d7a074d637d13743bb7/da8b6/architecture.png 1000w,\n/static/99246e95272d0d7a074d637d13743bb7/e4a85/architecture.png 1287w\"\n            sizes=\"(max-width: 1000px) 100vw, 1000px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/99246e95272d0d7a074d637d13743bb7/da8b6/architecture.png\"\n            alt=\"서비스 아키텍처\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">서비스 아키텍처</figcaption>\n  </figure></p>\n<p><strong>핵심 구성 요소</strong></p>\n<table>\n<thead>\n<tr>\n<th>구성 요소</th>\n<th>역할</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">boj-chrome-plugin</code></td>\n<td>백준 status 페이지에서 제출 데이터 크롤링, 서버로 Submission 전송, 앱과의 인증 연동</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">boj-helper-server</code></td>\n<td>Submission CRUD, Supabase JWT 검증, Prisma를 통한 DB 영속화</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">boj-helper-app</code></td>\n<td>Supabase Auth 기반 로그인, 제출 목록/상세/메모 관리 UI 제공</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"1️-내가-맞닥뜨린-트러블슈팅\">1️⃣ 내가 맞닥뜨린 트러블슈팅</h2>\n<p>나는 시간순으로 다음과 같은 문제들을 겪었다. 먼저, 내가 겪은 문제를 소개하고 글의 후반부에서 근본 원인 분석과 해결책을 다루고자 한다.</p>\n<h3 id=\"첫번째-rls-보안을-키니까-permission-denied\">첫번째, RLS 보안을 키니까 permission denied..?</h3>\n<p>개발을 하다가 DB에 <code class=\"language-text\">RLS</code> 보안을 설정하지 않고 개발을 하고 있다는 것을 깨달았다. 문득 “이거 RLS 안 켜고 개발하는 거 위험한데?”라는 생각이 들어 RLS를 활성화했다. 켜자마자 앱 전체에서 <code class=\"language-text\">permission denied</code> 에러가 발생했는데..</p>\n<blockquote>\n<p>💡 <strong>RLS(Row Level Security)란?</strong></p>\n<p>데이터베이스의 각 행(row)에 대한 접근 권한을 사용자별로 제어하는 <code class=\"language-text\">PostgreSQL</code>의 보안 기능이다.</p>\n</blockquote>\n<p>데이터 보안을 강화하기 위해 Supabase의 RLS(Row Level Security)를 활성화했다.</p>\n<p>RLS OFF 상태에서는 모든 쿼리가 정상 동작했다. 하지만 RLS를 켜는 순간, Next.js 앱 전체에서 <code class=\"language-text\">permission denied</code> 에러가 터졌다.</p>\n<ul>\n<li>로그인은 되어 있었다.</li>\n<li>토큰도 있었다.\n그런데 왜 <code class=\"language-text\">permission denied</code>가 발생하는 걸까?</li>\n</ul>\n<h3 id=\"두번째-ssr에서-액세스-토큰이-null\">두번째, SSR에서 액세스 토큰이 null</h3>\n<p>서버 컴포넌트에서 <code class=\"language-text\">getAccessToken()</code>을 호출하면 간헐적으로 <code class=\"language-text\">null</code>이 반환됐다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> supabase <span class=\"token operator\">=</span> <span class=\"token function\">createClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> session <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> supabase<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> session<span class=\"token operator\">?.</span>access_token <span class=\"token operator\">??</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// ❌ 가끔 null 반환</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>브라우저에서는 정상 동작하는데, 서버에서만 세션을 잃어버리는 현상이었다. Next.js App Router의 SSR 환경에서 Supabase client가 제대로 세션을 유지하지 못하고 있었다.</p>\n<h3 id=\"세번째-백준-문제-제출환경에서-토큰-자동-갱신을-어떻게-\">세번째, 백준 문제 제출환경에서 토큰 자동 갱신을 어떻게 ?</h3>\n<p>Chrome Extension을 설치하고 백준 제출을 몇 개 올린 뒤 1시간 정도가 지나면, 서버에서 <code class=\"language-text\">401 Unauthorized</code> 에러가 발생하고, 이후에 제출을 해도 제출이 수집되지 않는다. 유저가 확장 프로그램에서 직접 로그인을 하여 토큰을 전달해야 했다.\nSupabase access token의 주기가 1시간이기에, 유저 입장에서 1시간마다 직접 이 행동을 한다는 것은 매우 불편한 경험이었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 🚨 1시간 후 에러</span>\n<span class=\"token constant\">POST</span> <span class=\"token operator\">/</span>api<span class=\"token operator\">/</span>submissions\n<span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> Bearer <span class=\"token punctuation\">[</span>만료된 토큰<span class=\"token punctuation\">]</span>\n→ <span class=\"token number\">401</span> Unauthorized</code></pre></div>\n<p>나는 Supabase access token의 기본 만료 시간이 1시간이라는 걸 간과했다. 웹 앱에서는 Supabase SDK가 자동으로 토큰을 갱신해주지만, Chrome Extension의 content script 환경에서는 그런 메커니즘이 작동하지 않았다.</p>\n<p>위 세가지 트러블 슈팅 상황과 직결되어 있는 다음과 같은 근본적인 질문들이 이어서 떠올랐다.</p>\n<ul>\n<li>RLS는 <code class=\"language-text\">auth.uid()</code>를 요구하는데, 이게 어떻게 전달되고 있지?</li>\n<li>Next.js의 <code class=\"language-text\">SSR/CSR</code> 환경에서 세션을 유지하는 <code class=\"language-text\">best practice</code>는 뭘까?</li>\n<li><code class=\"language-text\">Chrome Extension</code>은 브라우저와 다른 환경인데, <code class=\"language-text\">토큰 갱신</code>은 어떻게 처리해야 하지?</li>\n</ul>\n<p>이 문제들을 해결하기 위해 근본 원인을 분석해보자.</p>\n<h2 id=\"2️-어떻게-해결해야할까\">2️⃣ 어떻게 해결해야할까</h2>\n<h3 id=\"사전-지식\">사전 지식</h3>\n<h4 id=\"anon_key와-service-role-key의-권한-차이\">anon_key와 service role key의 권한 차이</h4>\n<p>Supabase를 처음 접하면 <code class=\"language-text\">anon_key</code>를 클라이언트 <code class=\"language-text\">인증 키</code>처럼 생각하기 쉽다. 하지만 <code class=\"language-text\">anon_key</code>는 단순한 <strong>클라이언트 식별용 public key</strong>일 뿐이다.</p>\n<p><a href=\"https://supabase.com/docs/guides/api/api-keys#anon-and-publishable-keys\">supabase 공식 문서 - anon and publishable keys</a></p>\n<blockquote>\n<p>💡 <strong>Supabase anon_key란?</strong></p>\n<p>Supabase에서 제공하는 공개 키로, 클라이언트가 Supabase 서비스에 접근할 때 사용한다. \"익명(anonymous)\" 키라는 이름이지만, 실제로는 입장권일 뿐이고 슈퍼키가 아니다. 만약 클라이언트 환경에서 해당 키를 탈취하고 누구나 이 키로 데이터베이스를 조작할 수 있는 상황이 발생하게 된다면 이는 심각한 보안 위협이 될 수 있다.\n그러므로 실제 권한은,</p>\n<ul>\n<li>🔑 <strong>JWT (access token)</strong> - 사용자를 식별</li>\n<li>🔒 <strong>RLS 정책</strong> - 데이터 접근 제어</li>\n<li>🧠 <strong>서버 로직</strong> - 비즈니스 규칙 검증\n에서 부여해야 한다.</li>\n</ul>\n</blockquote>\n<blockquote>\n<p>💡 <strong>RLS(Row Level Security)란?</strong></p>\n<p>데이터베이스의 각 행(row)에 대한 접근 권한을 사용자별로 제어하는 PostgreSQL의 보안 기능이다.</p>\n</blockquote>\n<p>RLS가 활성화된 상태에서는 <code class=\"language-text\">anon_key</code>만 가지고는 DB에 아무 작업도 수행할 수 없다. (기본값: 모든 접근 금지)</p>\n<p>반면에, <code class=\"language-text\">service role key</code>의 경우는 슈퍼유저 권한을 가지며, RLS 정책을 완전히 우회할 수 있다. 따라서 비교적 안전한 백엔드에서 <code class=\"language-text\">service role key</code>를 사용하여 RLS를 우회하고, 비즈니스 로직에서 최종 권한 검증을 수행하는 것이 안전한 패턴이다.</p>\n<p>애초에 RLS 정책을 사용하는 이유가, 보안 계층을 한단계 더 만들어 클라이언트가 <code class=\"language-text\">anon_key</code>를 탈취하더라도 데이터베이스에 직접 접근하는 것을 막기 위함이기 때문이다.</p>\n<p>그래서 나는 <code class=\"language-text\">Nest.js</code> 서버 단에서 service role key를 사용하고, DB 접근 없이 supabase인증 api에 접근하는 <code class=\"language-text\">Next.js</code> 단에서는 <code class=\"language-text\">anon_key</code>로만 <code class=\"language-text\">supabase client</code>만 생성했다.\n(토큰 검증로직이 <code class=\"language-text\">Nest.js</code> 서버 단에 있는 것이 아닌, <code class=\"language-text\">Supabase Auth</code>에 위임되어 있음)</p>\n<h4 id=\"서비스-rls-정책\">서비스 RLS 정책</h4>\n<p>그리고 RLS 정책에는 다음과 같이 추가했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">USING (auth.uid() = user_id);</code></pre></div>\n<p>auth.uid()는 JWT 세션에서 유저 ID를 추출하는 함수이다. 즉, 내가 설정했던 RLS 정책은 \"현재 인증된 사용자의 ID와 행의 user_id가 일치할 때만 접근을 허용\"한다는 의미이다.</p>\n<h3 id=\"첫번째-근본-원인-클라이언트-컴포넌트의-세션-일관성-문제\">첫번째 근본 원인: 클라이언트 컴포넌트의 세션 일관성 문제</h3>\n<p>RLS 보안을 키니까 Next.js 클라이언트에서 <code class=\"language-text\">permission denied</code> 에러가 발생했던 근본 원인을 분석해보자.</p>\n<p>RLS 정책에서 사용하는 <code class=\"language-text\">auth.uid()</code>는 Supabase client에 <strong>JWT 세션이 붙어 있어야만</strong> 존재한다. 아래는 permission denied 문제가 발생한 Next.js 클라이언트 컴포넌트에 Supabse client를 생성하는 코드의 예시이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 예시</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createBrowserClient</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> anon_key<span class=\"token punctuation\">)</span> <span class=\"token comment\">// ❌</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 되면 렌더링 할 떄마다 매번 새로운 Supabase client 인스턴스가 생성된다.\n이에 따라 각 client는 독립적인 auth context 가지게 되어 로그인 세션이 있어도, 새 client는 이를 알지 못하게 된다.</p>\n<p>결과적으로 <code class=\"language-text\">auth.uid()</code> = <code class=\"language-text\">null</code> → RLS 조건 불만족 → permission denied 에러가 발생한 것이었다.</p>\n<blockquote>\n<p>💡 <strong>Supabase에서의 세션 관리</strong></p>\n<p>Supabase는 세션을 localStorage와 메모리에 유지하며, <strong>같은 client 인스턴스에서 auth 상태를 추적</strong>한다.</p>\n</blockquote>\n<p>그러므로 세션 일관성 유지를 위해서는 다음 원칙을 지켜야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">하나의 사용자 세션 = 하나의 Supabase client</code></pre></div>\n<p>해결책은 간단했다. Supabase client를 <code class=\"language-text\">싱글톤 패턴</code>으로 만들어,\n애플리케이션 전체에서 동일한 client 인스턴스를 재사용하도록 변경했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 싱글톤 패턴의 예시</span>\n<span class=\"token keyword\">let</span> <span class=\"token literal-property property\">browserClient</span><span class=\"token operator\">:</span> SupabaseClient <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> window <span class=\"token operator\">===</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">createBrowserClient</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> anon_key<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>browserClient<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> browserClient <span class=\"token comment\">// ✅ 재사용</span>\n\n  browserClient <span class=\"token operator\">=</span> <span class=\"token function\">createBrowserClient</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> anon_key<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> browserClient\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"두번째-근본-원인-서버-컴포넌트의-세션-관리-문제\">두번째 근본 원인: 서버 컴포넌트의 세션 관리 문제</h3>\n<blockquote>\n<p>SSR 환경에서 Supabase 세션을 어떻게 유지해야 할까?</p>\n</blockquote>\n<p>Next.js의 SSR 환경에서는 브라우저 환경에 접근이 불가능하기 때문에, 쿠키 기반으로 Supabase client를 생성해야 하고, 당연히 클라이언트 컴포넌트와는 다른 방식으로 세션을 유지해야 한다.</p>\n<p>기존에는 세션을 getAccessToken() 안에서 조회만 했다. 너무 쉽게 갱신이 알아서 되겠거니와 생각을 했떤 거 같다. 하지만 이럴 경우 <code class=\"language-text\">Next.js 서버</code> 단에서 토큰이 만료되어도 세션을 갱신하지 않게 되므로, 예외상황이 발생했다.</p>\n<p>그렇다면, 서버 컴포넌트에서는 토큰이 만료되었는지 사전에 확인하고, 만료되었거나 곧 만료될 예정이라면 미리 갱신하는 로직이 필요하다. 그래서 나는 토큰을 쿠키를 통해 꺼낼 떄 해당 토큰의 만료 예정 시각을 확인하여, 토큰이 만료되었거나 곧 만료될 예정이라면 <code class=\"language-text\">refreshSession()</code>을 호출하여 토큰을 갱신하도록 변경했다.</p>\n<h3 id=\"세번째-근본-원인-extension의-content-script-환경\">세번째 근본 원인: Extension의 content script 환경</h3>\n<blockquote>\n<p>유저의 Extension 환경에서 Supabase 세션을 어떻게 유지해야 할까?</p>\n</blockquote>\n<p>브라우저 전역에서 저장할 수 있는 공간이 뭐가 있을까 찾아보다가, <code class=\"language-text\">chrome.storage.local</code> 이라는 공간이 있다는 것을 알게 되었다.</p>\n<p>하지만 브라우저 환경과는 다르게, Chrome Extension의 content script 환경에서는 Supabase SDK의 자동 갱신 메커니즘이 작동하지 않는다. supabase sdk는 브라우저의 <code class=\"language-text\">localStorage</code>를 사용하여 세션을 관리하는데, content script는 브라우저의 localStorage와 완전히 분리되어 있기 때문이다.</p>\n<p>그렇다면 세션 갱신을, 주기적으로 백그라운드에서 수행하는 방법이 필요하겠다.</p>\n<h2 id=\"4️-환경별-토큰-갱신-전략\">4️⃣ 환경별 토큰 갱신 전략</h2>\n<p>위에서의 고민을 바탕으로 확립한 서버, 클라이언트, Extension 환경별 토큰 갱신 전략을 정리했다.</p>\n<h3 id=\"server-proactive-refresh\">Server: Proactive Refresh</h3>\n<p>서버 컴포넌트에서는 <strong>API 호출 전에 토큰을 미리 갱신</strong>한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> supabase <span class=\"token operator\">=</span> <span class=\"token function\">createClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// createServerClient (쿠키 기반)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> session <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> supabase<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>session<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">const</span> expiresAt <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">.</span>expires_at <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> now <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 만료됐거나 60초 이내면 갱신</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>expiresAt<span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> now<span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">60000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">session</span><span class=\"token operator\">:</span> newSession <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> supabase<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">refreshSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newSession<span class=\"token operator\">?.</span>access_token <span class=\"token operator\">??</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> session<span class=\"token punctuation\">.</span>access_token\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"동작-원리\">동작 원리</h4>\n<ul>\n<li>만료 여부를 <code class=\"language-text\">expires_at</code>으로 사전 확인</li>\n<li>만료 전에 미리 갱신</li>\n<li>API 호출 시 항상 유효한 토큰 사용</li>\n</ul>\n<h3 id=\"client-reactive-refresh\">Client: Reactive Refresh</h3>\n<p>클라이언트 컴포넌트에서는 액세스 토큰 만료 시 <strong>401 응답을 받은 후에 갱신</strong>한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">fetchWithRefreshMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> supabase <span class=\"token operator\">=</span> <span class=\"token function\">createClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// createBrowserClient</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> session <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> supabase<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 첫 요청</span>\n  <span class=\"token keyword\">let</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>options<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>options<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>session<span class=\"token punctuation\">.</span>access_token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 401이면 재시도</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">401</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> supabase<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">refreshSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">session</span><span class=\"token operator\">:</span> newSession <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> supabase<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>options<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>options<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>newSession<span class=\"token punctuation\">.</span>access_token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> response\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h5>동작 원리</h5>\n<ul>\n<li>만료 여부 확인 없이 일단 요청</li>\n<li>401 응답 시 갱신 (reactive)</li>\n<li>같은 요청 재시도</li>\n</ul>\n<p><strong>서버 vs 클라이언트 비교</strong></p>\n<table>\n<thead>\n<tr>\n<th>구분</th>\n<th>서버 컴포넌트</th>\n<th>클라이언트 컴포넌트</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>리프레시 시점</td>\n<td>API 호출 전 (만료/60초 이내면 미리 갱신)</td>\n<td>API 호출 후 401 발생 시 갱신 후 재시도</td>\n</tr>\n<tr>\n<td>만료 판단</td>\n<td><code class=\"language-text\">expires_at vs now + 60</code></td>\n<td>사용 안 함 (401로 판단)</td>\n</tr>\n<tr>\n<td>방식</td>\n<td>Proactive (예방적)</td>\n<td>Reactive (대응적)</td>\n</tr>\n<tr>\n<td>토큰 저장</td>\n<td>쿠키 (<code class=\"language-text\">cookies()</code>)</td>\n<td>브라우저 스토리지</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"extension-background-alarm\">Extension: Background Alarm</h3>\n<p>Chrome Extension에서는 background alarm 기능을 통해 브라우저의 백그라운드에서 주기적인 작업을 수행할 수 있다.</p>\n<h5>chrome.alarms 사용</h5>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// background.js - 알람 등록</span>\nchrome<span class=\"token punctuation\">.</span>alarms<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">periodInMinutes</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 알람 리스너</span>\nchrome<span class=\"token punctuation\">.</span>alarms<span class=\"token punctuation\">.</span>onAlarm<span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token parameter\">alarm</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>alarm<span class=\"token punctuation\">.</span>name <span class=\"token operator\">!==</span> <span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> refreshToken <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> chrome<span class=\"token punctuation\">.</span>storage<span class=\"token punctuation\">.</span>local<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token constant\">REFRESH_TOKEN_KEY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>refreshToken<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> newAccessToken <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">refreshAccessToken</span><span class=\"token punctuation\">(</span>refreshToken<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">await</span> chrome<span class=\"token punctuation\">.</span>storage<span class=\"token punctuation\">.</span>local<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">[</span><span class=\"token constant\">ACCESS_TOKEN_KEY</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> newAccessToken<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Token refresh failed:\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h5>동작 원리</h5>\n<ul>\n<li>Supabase access token 만료: 1시간</li>\n<li>알람 주기: 50분 (만료 전에 갱신)</li>\n<li>사용자 액션 불필요 (자동 갱신)</li>\n<li>Manifest V3 service worker도 알람 시점에 깨어남</li>\n</ul>\n<h2 id=\"5️-최종-교훈\">5️⃣ 최종 교훈</h2>\n<h3 id=\"1-세션-일관성-지키기\">1. 세션 일관성 지키기</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">하나의 사용자 세션 = 하나의 Supabase client</code></pre></div>\n<p>client를 매번 새로 생성하면:</p>\n<ul>\n<li>로그인 세션이 있어도</li>\n<li>Supabase 내부 auth context는 리셋</li>\n</ul>\n<p><strong>해결: Client <code class=\"language-text\">싱글톤 패턴</code></strong></p>\n<h3 id=\"2-환경별-세션-관리-방법의-차이\">2. 환경별 세션 관리 방법의 차이</h3>\n<table>\n<thead>\n<tr>\n<th>환경</th>\n<th>토큰 저장</th>\n<th>갱신 전략</th>\n<th>갱신 시점</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Server Component</td>\n<td>쿠키</td>\n<td>Proactive</td>\n<td>API 호출 전 (만료 60초 전)</td>\n</tr>\n<tr>\n<td>Client Component</td>\n<td>브라우저 스토리지</td>\n<td>Reactive</td>\n<td>401 응답 후</td>\n</tr>\n<tr>\n<td>Chrome Extension</td>\n<td>chrome.storage</td>\n<td>Background Periodic</td>\n<td>50분마다 자동</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"3-supabase-보안-설정\">3. Supabase 보안 설정</h3>\n<div class=\"gatsby-highlight\" data-language=\"tx\"><pre class=\"language-tx\"><code class=\"language-tx\">1단계: Client (anon_key + JWT)\n  2단계: → Server (JWT 검증 + 비즈니스 로직)\n    3단계: → DB (RLS 정책)</code></pre></div>","fields":{"slug":"/[트러블슈팅] Supabase를 활용한 인증, 인가/"},"frontmatter":{"title":"[트러블슈팅] Supabase Auth를 활용한 다양한 환경에서의 세션 유지","date":"2026-02-10","description":"RLS를 켜자마자 permission denied, SSR에서 토큰 null, Extension에서 1시간 뒤 401. Supabase Auth 기반 인증 시스템을 구축하며 마주한 문제들과 해결 과정을 기록한다.","pointColor":"#3ECF8D","tags":["Web","회고"],"keywords":null,"thumbnail":{"publicURL":"/static/568dd75c097bfe6c382803eb7236db7d/index.png","childImageSharp":{"gatsbyImageData":{"layout":"fixed","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAACE4AAAhOAFFljFgAAABfElEQVR42qVS207CQBDtbrf3bmnL3RZBSUFUJF6CD4qJYNTE+GjwQaI++wUm/vtxdwGFqNHIw+TMzu6czjlTTdM0rBqGaSKIQzDG5Pn/RIQQhblSHt3JFXzuLxCKS2rooJYBYhrQBTLXAqEURKegJgO1Teierd5I1H1HvGWwfA88mk9IpoTyQfpwjmQ8QGHYQ/m2j+xtjHQyRHTcRvo4Qu1phMbLDUrXB1h/vkD2eofk/gzFy30Qps8nn40vpnBqBVjVCHY1hi6mk7nXSmDEXNXstRjuRhlWJYLbKMFrVmCLnHFHKVkiVKTiK9Q2FBJKlExphcwVyrqwhQUOmC/DhhF6yoIFnk9Cxl04aR58p4Zgr45gdx1BrwG/ncDLquDi7G6WEfYzhEdNxINtxKcdmIXgYw/LW55tza0XEXTrsAW530mRO2wKH1uqWdal1PhkS1gSLvV9mXAe0j8pR3cECknSI5ZzYeS5uDOncgNXyf+mf/Uf+3dC8of8h3gH7kr1yKjoNUcAAAAASUVORK5CYII="},"backgroundColor":"transparent","images":{"fallback":{"src":"/static/568dd75c097bfe6c382803eb7236db7d/625ce/index.png","srcSet":"/static/568dd75c097bfe6c382803eb7236db7d/625ce/index.png 1200w","sizes":"1200px"},"sources":[{"srcSet":"/static/568dd75c097bfe6c382803eb7236db7d/f3298/index.webp 1200w","type":"image/webp","sizes":"1200px"}]},"width":1200,"height":662},"fixed":{"src":"/static/568dd75c097bfe6c382803eb7236db7d/f3583/index.png"}}}}},"previous":{"fields":{"slug":"/waterfall-agile/"},"frontmatter":{"title":"[소프트웨어공학] Waterfall과 Agile"}},"next":null},"pageContext":{"id":"cca09ce6-a2ec-51d7-8e07-d9e9c42f230e","previousPostId":"d00dccb0-7f21-5871-9417-160c4a3ae8d0","nextPostId":null}},"staticQueryHashes":["736397157"],"slicesMap":{}}